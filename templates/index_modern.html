<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Farmacias Chile - Encuentra tu farmacia con IA</title>
    <meta name="description" content="Encuentra farmacias de turno en Chile con nuestro asistente inteligente en espa√±ol. B√∫squeda por ubicaci√≥n, horarios y medicamentos disponibles.">
    <meta name="theme-color" content="#1a1a2e">
    
    <!-- Favicon -->
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%234CAF50' rx='6'/><rect x='13' y='8' width='6' height='16' fill='white'/><rect x='8' y='13' width='16' height='6' fill='white'/></svg>">
    
    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- Google Fonts - Inter for modern typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Our custom CSS -->
    <link rel="stylesheet" href="/templates/assets/css/themes.css">
    <link rel="stylesheet" href="/templates/assets/css/main.css">
    <link rel="stylesheet" href="/templates/assets/css/components.css">
    
    <!-- PWA Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Farmacias Chile">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Farmacias Chile - Encuentra tu farmacia con IA">
    <meta property="og:description" content="Asistente inteligente para encontrar farmacias de turno en Chile">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/templates/assets/images/og-image.jpg">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Farmacias Chile",
      "description": "Encuentra farmacias de turno en Chile con asistente inteligente",
      "applicationCategory": "HealthApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "CLP"
      }
    }
    </script>
</head>
<body>
    <!-- App Header with Theme Toggle -->
    <header class="app-header">
        <div class="header-left">
            <a href="/" class="logo">
                üè• Farmacias Chile
            </a>
        </div>
        <div class="header-right">
            <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema">
                <div class="theme-toggle-track">
                    <div class="theme-toggle-thumb">
                        <span class="theme-icon theme-icon-sun">‚òÄÔ∏è</span>
                        <span class="theme-icon theme-icon-moon">üåô</span>
                    </div>
                </div>
            </button>
        </div>
    </header>

    <!-- Hero Section = Main Chat Interface -->
    <section class="hero-section">
        <div class="hero-main-interface">
            <div class="hero-container">
                <!-- Left Side: Chat Interface -->
                <div class="chat-main-panel">
                    <div class="chat-header-main">
                        <div class="ai-avatar-large">ü§ñ</div>
                        <div class="ai-info-main">
                            <h2>Asistente Farmac√©utico</h2>
                            <p>Encuentra farmacias cerca de ti</p>
                        </div>
                    </div>
                    
                    <!-- Chat History Display -->
                    <div class="chat-messages-main" id="mainChatMessages">
                        <div class="message ai-message-main">
                            <div class="message-content-main">
                                <p>¬°Hola! Ingresa tu direcci√≥n o preg√∫ntame sobre farmacias cerca de ti.</p>
                                <span class="message-time-main">Ahora</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="chat-input-main">
                        <input type="text" 
                               placeholder="Pregunta: ¬øHay farmacia de turno en Santiago?" 
                               id="mainChatInput"
                               class="chat-input-field-main"
                               autocomplete="off">
                        <button id="mainChatSend" class="chat-send-main">
                            Enviar
                        </button>
                    </div>
                </div>
                
                <!-- Right Side: Address & Map -->
                <div class="location-panel">
                    <div class="address-input-section">
                        <label for="addressInput">üìç Tu Ubicaci√≥n</label>
                        <div class="address-input-container">
                            <input type="text" 
                                   id="addressInput"
                                   placeholder="Ej: Providencia 123, Santiago"
                                   class="address-input-field"
                                   autocomplete="off">
                            <button id="useLocationBtn" class="use-location-btn">
                                üìç Usar mi ubicaci√≥n
                            </button>
                        </div>
                        <div id="addressSuggestions" class="address-suggestions"></div>
                    </div>
                    
                    <!-- Mini Map Preview -->
                    <div class="map-preview-container">
                        <div id="mapPreview" class="map-preview"></div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions-main">
                        <button class="action-btn-main" data-action="open-now">üïê Abiertas ahora</button>
                        <button class="action-btn-main" data-action="medications">üíä Medicamentos</button>
                        <button class="action-btn-main" data-action="nearest">üöó M√°s cercana</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Statistics Section -->
        <section class="stats-section">
            <div class="stats-grid">
                <div class="stat-card fade-in stagger-1">
                    <div class="stat-number" id="total-pharmacies">0</div>
                    <div class="stat-label">Total Farmacias</div>
                </div>
                <div class="stat-card fade-in stagger-2">
                    <div class="stat-number" id="open-pharmacies">0</div>
                    <div class="stat-label">De Turno</div>
                </div>
                <div class="stat-card fade-in stagger-3">
                    <div class="stat-number" id="communes-count">0</div>
                    <div class="stat-label">Comunas</div>
                </div>
                <div class="stat-card fade-in stagger-4">
                    <div class="stat-time" id="current-time">--:--:--</div>
                    <div class="stat-label">Hora Actual</div>
                </div>
            </div>
        </section>

        <!-- Search Controls -->
        <section class="search-controls">
            <div class="search-controls-grid">
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input"
                    placeholder="Buscar por comuna (ej: santiago, valpara√≠so)" 
                    list="communes-list" 
                    autocomplete="off"
                >
                <datalist id="communes-list">
                    <!-- Communes will be loaded dynamically -->
                </datalist>
                
                <select id="filter-select" class="filter-select">
                    <option value="all">Todas las farmacias</option>
                    <option value="open">Solo de turno</option>
                    <option value="open-now">Abiertas ahora</option>
                </select>
                
                <button id="search-btn" class="btn btn-primary">
                    üîç Buscar
                </button>
                
                <button id="location-btn" class="btn btn-success">
                    üìç Mi Ubicaci√≥n
                </button>
                
                <button id="clear-btn" class="btn btn-secondary">
                    üóëÔ∏è Limpiar
                </button>
            </div>
        </section>

        <!-- Map Section -->
        <section class="content-section">
            <div class="section-header">
                <h2 class="section-title">üó∫Ô∏è Mapa Interactivo</h2>
            </div>
            <div class="section-content">
                <div class="map-section">
                    <div id="map"></div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="content-section results-section">
            <div class="section-header">
                <div class="results-header">
                    <h2 class="results-title">üìã Farmacias Encontradas</h2>
                    <div class="results-count" id="results-count">
                        Realiza una b√∫squeda para ver resultados
                    </div>
                </div>
                <div class="filter-chips" id="filter-chips">
                    <span class="chip active" data-filter="all">Todas</span>
                    <span class="chip" data-filter="open">De Turno</span>
                    <span class="chip" data-filter="open-now">Abiertas Ahora</span>
                    <span class="chip" data-filter="nearby">Cercanas</span>
                </div>
            </div>
            <div class="section-content">
                <div id="results-container">
                    <!-- Results will be populated here -->
                    <div class="pharmacy-grid-empty">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">Busca tu farmacia ideal</div>
                        <div class="empty-description">
                            Usa el buscador o nuestro asistente inteligente para encontrar farmacias cerca de ti.
                        </div>
                        <button class="btn btn-primary" onclick="document.getElementById('search-input').focus()">
                            Comenzar b√∫squeda
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando...</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Our JavaScript modules -->
    <script type="module">
        // Import our modules
        import { ThemeManager } from '/templates/assets/js/theme.js';
        import { PharmacyFinder } from '/templates/assets/js/main.js';
        
        // Initialize the application
        class App {
            constructor() {
                this.theme = new ThemeManager();
                this.pharmacyFinder = new PharmacyFinder();
                this.sessionId = null; // Initialize chat session ID
                this.mapPreview = null; // Map preview instance
                this.currentLocationMarker = null; // Current location marker
                this.initIntegratedChat();
                
                // Make globally available for legacy code
                window.app = this.pharmacyFinder;
                window.themeManager = this.theme;
                
                console.log('üöÄ Integrated Pharmacy Finder App initialized');
            }
            
            initIntegratedChat() {
                const chatInput = document.getElementById('mainChatInput');
                const chatSend = document.getElementById('mainChatSend');
                const chatMessages = document.getElementById('mainChatMessages');
                const addressInput = document.getElementById('addressInput');
                const useLocationBtn = document.getElementById('useLocationBtn');
                
                console.log('üîß Initializing integrated chat...', {
                    chatInput: !!chatInput,
                    chatSend: !!chatSend,
                    chatMessages: !!chatMessages
                });
                
                // Initialize map preview
                this.initMapPreview();
                
                if (chatInput && chatSend) {
                    chatSend.addEventListener('click', () => {
                        console.log('üí¨ Send button clicked');
                        this.sendMessage();
                    });
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            console.log('üí¨ Enter key pressed');
                            this.sendMessage();
                        }
                    });
                    console.log('‚úÖ Chat event listeners attached');
                } else {
                    console.error('‚ùå Chat elements not found!');
                }
                
                if (useLocationBtn) {
                    useLocationBtn.addEventListener('click', () => this.useCurrentLocation());
                }
                
                // Address input with autocomplete
                if (addressInput) {
                    addressInput.addEventListener('input', (e) => this.handleAddressInput(e.target.value));
                }
                
                // Quick action buttons
                document.querySelectorAll('.action-btn-main').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.dataset.action;
                        this.handleQuickAction(action);
                    });
                });
            }
            
            initMapPreview() {
                // Initialize map preview
                try {
                    if (window.L) {
                        this.mapPreview = L.map('mapPreview', {
                            zoomControl: false,
                            attributionControl: false,
                            dragging: false,
                            touchZoom: false,
                            doubleClickZoom: false,
                            scrollWheelZoom: false,
                            boxZoom: false,
                            keyboard: false
                        }).setView([-33.4489, -70.6693], 10);

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: ''
                        }).addTo(this.mapPreview);
                        
                        console.log('üó∫Ô∏è Map preview initialized');
                    } else {
                        console.warn('Leaflet not loaded, map preview not initialized');
                    }
                } catch (error) {
                    console.error('Error initializing map preview:', error);
                }
            }
            
            async sendMessage() {
                console.log('üì§ sendMessage called');
                const input = document.getElementById('mainChatInput');
                const message = input.value.trim();
                console.log('üí¨ Message to send:', message);
                
                if (!message) {
                    console.log('‚ùå Empty message, returning');
                    return;
                }
                
                this.addMessage('user', message);
                input.value = '';
                
                // Add typing indicator
                this.showTypingIndicator();
                
                const payload = { 
                    message: message,
                    session_id: this.sessionId || null 
                };
                console.log('üì§ Sending payload:', payload);
                
                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log('üì• Response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('üì• Response data:', data);
                    
                    this.hideTypingIndicator();
                    
                    // Store session ID for future messages
                    if (data.session_id) {
                        this.sessionId = data.session_id;
                        console.log('üîê Session ID stored:', this.sessionId);
                    }
                    
                    // Display AI response
                    const aiMessage = data.reply || data.response || 'Respuesta recibida';
                    this.addMessage('ai', aiMessage);
                    
                    // Show tools used if any
                    if (data.tools_used && data.tools_used.length > 0) {
                        console.log('üîß Tools used:', data.tools_used);
                        this.addMessage('ai', `üîß Herramientas utilizadas: ${data.tools_used.join(', ')}`);
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error sending message:', error);
                    this.hideTypingIndicator();
                    this.addMessage('ai', 'Lo siento, hubo un error conectando con el servidor. Por favor intenta de nuevo.');
                }
            }
            
            showTypingIndicator() {
                const messagesContainer = document.getElementById('mainChatMessages');
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'message ai-message-main typing-indicator';
                typingDiv.innerHTML = `
                    <div class="message-content-main">
                        <div class="typing-dots">
                            <span></span><span></span><span></span>
                        </div>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">El asistente est√° escribiendo...</span>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            hideTypingIndicator() {
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
            handleAddressInput(value) {
                if (value.length < 3) {
                    this.hideAddressSuggestions();
                    return;
                }
                
                // Simple address suggestions (can be enhanced with real geocoding API)
                const suggestions = [
                    'Santiago, Regi√≥n Metropolitana',
                    'Providencia, Santiago',
                    'Las Condes, Santiago',
                    '√ëu√±oa, Santiago',
                    'Valpara√≠so, Regi√≥n de Valpara√≠so',
                    'Vi√±a del Mar, Regi√≥n de Valpara√≠so',
                    'Concepci√≥n, Regi√≥n del Biob√≠o'
                ].filter(suggestion => 
                    suggestion.toLowerCase().includes(value.toLowerCase())
                );
                
                this.showAddressSuggestions(suggestions);
            }
            
            showAddressSuggestions(suggestions) {
                const container = document.getElementById('addressSuggestions');
                if (!container) return;
                
                if (suggestions.length === 0) {
                    this.hideAddressSuggestions();
                    return;
                }
                
                container.innerHTML = suggestions.map(suggestion => 
                    `<div class="suggestion-item" onclick="app.selectAddress('${suggestion}')">${suggestion}</div>`
                ).join('');
                
                container.style.display = 'block';
            }
            
            hideAddressSuggestions() {
                const container = document.getElementById('addressSuggestions');
                if (container) {
                    container.style.display = 'none';
                }
            }
            
            selectAddress(address) {
                const input = document.getElementById('addressInput');
                if (input) {
                    input.value = address;
                    this.hideAddressSuggestions();
                    this.addMessage('ai', `üìç Ubicaci√≥n seleccionada: ${address}. Buscando farmacias cercanas...`);
                    // Here you would typically geocode the address and search for nearby pharmacies
                }
            }
            
            addMessage(type, content) {
                const messagesContainer = document.getElementById('mainChatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message-main`;
                
                const time = new Date().toLocaleTimeString('es-CL', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                messageDiv.innerHTML = `
                    <div class="message-content-main">
                        <p>${content}</p>
                        <span class="message-time-main">${time}</span>
                    </div>
                `;
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            useCurrentLocation() {
                console.log('üìç useCurrentLocation called');
                const useLocationBtn = document.getElementById('useLocationBtn');
                
                if (!navigator.geolocation) {
                    alert('Geolocalizaci√≥n no disponible en tu navegador');
                    return;
                }
                
                // Disable button and show loading state
                if (useLocationBtn) {
                    useLocationBtn.disabled = true;
                    useLocationBtn.textContent = 'üìç Obteniendo ubicaci√≥n...';
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        console.log('üìç Location obtained:', latitude, longitude);
                        
                        // Update the map preview with new location
                        if (this.mapPreview) {
                            this.mapPreview.setView([latitude, longitude], 14);
                            
                            // Remove existing marker if any
                            if (this.currentLocationMarker) {
                                this.mapPreview.removeLayer(this.currentLocationMarker);
                            }
                            
                            // Add new marker for current location
                            this.currentLocationMarker = L.marker([latitude, longitude])
                                .addTo(this.mapPreview)
                                .bindPopup('üìç Tu ubicaci√≥n actual')
                                .openPopup();
                        }
                        
                        // Update address input with reverse geocoding (simplified)
                        const addressInput = document.getElementById('addressInput');
                        if (addressInput) {
                            addressInput.value = `Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`;
                        }
                        
                        // Add message to chat
                        this.addMessage('ai', `üìç Ubicaci√≥n detectada. Buscando farmacias cerca de ti...`);
                        
                        // Instead of using pharmacyFinder.searchNearby, send a message to the AI agent
                        // This ensures the AI agent handles the search and provides a natural response
                        this.addMessage('user', `Buscar farmacias cerca de mi ubicaci√≥n: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                        
                        // Trigger the AI agent to process this request
                        setTimeout(() => {
                            this.sendMessage();
                        }, 500);
                        
                        // Reset button
                        if (useLocationBtn) {
                            useLocationBtn.disabled = false;
                            useLocationBtn.textContent = 'üìç Usar mi ubicaci√≥n';
                        }
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        this.addMessage('ai', 'No pude obtener tu ubicaci√≥n. Puedes ingresarla manualmente.');
                        
                        // Reset button
                        if (useLocationBtn) {
                            useLocationBtn.disabled = false;
                            useLocationBtn.textContent = 'üìç Usar mi ubicaci√≥n';
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }
            
            handleQuickAction(action) {
                switch(action) {
                    case 'open-now':
                        this.addMessage('user', 'Buscar farmacias abiertas ahora');
                        this.sendMessage();
                        break;
                    case 'medications':
                        this.addMessage('user', 'Informaci√≥n sobre medicamentos');
                        this.sendMessage();
                        break;
                    case 'nearest':
                        this.useCurrentLocation();
                        break;
                }
            }
        }
        
        // Start the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            window.app = new App();
        });
    </script>
    
    <!-- Service Worker Registration -->
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
</body>
</html>
