<!DOCTYPE html>
<html lang="es" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè• Farmacias Chile - Encuentra tu farmacia con IA</title>
    <meta name="description" content="Encuentra farmacias de turno en Chile con nuestro asistente inteligente en espa√±ol. B√∫squeda por ubicaci√≥n, horarios y medicamentos disponibles.">
    <meta name="theme-color" content="#1a1a2e">
    
    <!-- Favicon -->
<<<<<<< HEAD
    <link rel="icon" type="image/png" href="/templates/assets/images/logo1.png">
=======
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' fill='%234CAF50' rx='6'/><rect x='13' y='8' width='6' height='16' fill='white'/><rect x='8' y='13' width='16' height='6' fill='white'/></svg>">
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
    
    <!-- Preconnect to external resources -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="preconnect" href="https://unpkg.com">
    
    <!-- Google Fonts - Inter for modern typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <!-- Our custom CSS -->
    <link rel="stylesheet" href="/templates/assets/css/themes.css">
    <link rel="stylesheet" href="/templates/assets/css/main.css">
    <link rel="stylesheet" href="/templates/assets/css/components.css">
    
<<<<<<< HEAD
    <!-- Custom styles for map markers -->
    <style>
        .pharmacy-marker {
            background: transparent;
            border: none;
        }
        
        .marker-content {
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            position: relative;
        }
        
        .marker-content span {
            background: #4CAF50;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            position: absolute;
            top: -8px;
            right: -8px;
        }
        
        .user-location-marker {
            background: transparent;
            border: none;
            font-size: 20px;
        }
        
        .pharmacy-marker-preview {
            background: transparent;
            border: none;
        }
        
        .marker-content-preview {
            background: white;
            border: 2px solid #4CAF50;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 8px;
            font-weight: bold;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
        }
        
        .pharmacy-popup {
            font-family: 'Inter', sans-serif;
        }
        
        .pharmacy-popup h3 {
            margin: 0 0 8px 0;
            color: #4CAF50;
            font-size: 16px;
        }
        
        .pharmacy-popup p {
            margin: 4px 0;
            font-size: 14px;
        }
        
        .pharmacy-popup strong {
            color: #333;
        }
        
        /* App Header Styles */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e0e0e0;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            height: 60px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .header-left .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .header-right {
            display: flex;
            align-items: center;
        }
        
        /* Simple Theme Toggle Button */
        .theme-toggle {
            background: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 40px;
            height: 32px;
        }
        
        .theme-toggle:hover {
            background: #e0e0e0;
            transform: scale(1.05);
        }
        
        .theme-toggle:active {
            transform: scale(0.95);
        }
        
        .theme-icon {
            display: block;
            transition: all 0.3s ease;
        }
        
        /* Light theme shows moon (click to go dark) */
        .theme-icon::before {
            content: "üåô";
        }
        
        /* Dark theme styles */
        [data-theme="dark"] .theme-toggle {
            background: #444;
            border-color: #666;
            color: #fff;
        }
        
        [data-theme="dark"] .theme-toggle:hover {
            background: #555;
        }
        
        /* Dark theme shows sun (click to go light) */
        [data-theme="dark"] .theme-icon::before {
            content: "‚òÄÔ∏è";
        }
        
        [data-theme="dark"] .theme-icon {
            transform: rotate(20deg);
        }
        
        /* Prevent transitions during initial load */
        .no-transitions * {
            transition: none !important;
        }
        
        /* Dark theme styles for header */
        [data-theme="dark"] .app-header {
            background: rgba(30, 30, 30, 0.95);
            border-bottom-color: #444;
        }
        
        [data-theme="dark"] .header-left .logo {
            color: #fff;
        }
        
        /* Add top margin to body to account for fixed header */
        body {
            margin-top: 80px;
        }
        
        /* Typing indicator animation styles */
        .typing-avatar-container {
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .typing-indicator .message-content-main {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dots span {
            width: 8px;
            height: 8px;
            background: var(--primary-color);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }
        
        .typing-dots span:nth-child(1) { animation-delay: 0.0s; }
        .typing-dots span:nth-child(2) { animation-delay: 0.2s; }
        .typing-dots span:nth-child(3) { animation-delay: 0.4s; }
        
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
            40% { transform: scale(1); opacity: 1; }
        }
    </style>
    
    <!-- PWA Meta Tags -->
    <meta name="mobile-web-app-capable" content="yes">
=======
    <!-- PWA Meta Tags -->
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Farmacias Chile">
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Farmacias Chile - Encuentra tu farmacia con IA">
    <meta property="og:description" content="Asistente inteligente para encontrar farmacias de turno en Chile">
    <meta property="og:type" content="website">
    <meta property="og:image" content="/templates/assets/images/og-image.jpg">
    
    <!-- Structured Data -->
    <script type="application/ld+json">
    {
      "@context": "https://schema.org",
      "@type": "WebApplication",
      "name": "Farmacias Chile",
      "description": "Encuentra farmacias de turno en Chile con asistente inteligente",
      "applicationCategory": "HealthApplication",
      "operatingSystem": "Any",
      "offers": {
        "@type": "Offer",
        "price": "0",
        "priceCurrency": "CLP"
      }
    }
    </script>
</head>
<<<<<<< HEAD

<body>
    <!-- App Header with Theme Toggle (back inside body for JS access) -->
    <header class="app-header">
        <div class="header-left">
            <a href="/" class="logo">
                <img src="/templates/assets/images/logo1.png" alt="Logo" style="height: 32px; width: auto; margin-right: 8px; vertical-align: middle;">
                Farmacias Chile
=======
<body>
    <!-- App Header with Theme Toggle -->
    <header class="app-header">
        <div class="header-left">
            <a href="/" class="logo">
                üè• Farmacias Chile
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
            </a>
        </div>
        <div class="header-right">
            <button class="theme-toggle" id="themeToggle" aria-label="Cambiar tema">
<<<<<<< HEAD
                <span class="theme-icon"></span>
=======
                <div class="theme-toggle-track">
                    <div class="theme-toggle-thumb">
                        <span class="theme-icon theme-icon-sun">‚òÄÔ∏è</span>
                        <span class="theme-icon theme-icon-moon">üåô</span>
                    </div>
                </div>
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
            </button>
        </div>
    </header>

<<<<<<< HEAD
    <!-- Header Stats Bar -->
    <section class="header-stats-section">
        <div class="stats-grid">
            <div class="stat-card fade-in stagger-1">
                <div class="stat-number" id="total-pharmacies">0</div>
                <div class="stat-label">Total Farmacias</div>
            </div>
            <div class="stat-card fade-in stagger-2">
                <div class="stat-number" id="open-pharmacies">0</div>
                <div class="stat-label">De Turno</div>
            </div>
            <div class="stat-card fade-in stagger-3">
                <div class="stat-number" id="communes-count">0</div>
                <div class="stat-label">Comunas</div>
            </div>
            <div class="stat-card fade-in stagger-4">
                <div class="stat-time" id="current-time">--:--:--</div>
                <div class="stat-label">Hora Actual</div>
            </div>
        </div>
    </section>

=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
    <!-- Hero Section = Main Chat Interface -->
    <section class="hero-section">
        <div class="hero-main-interface">
            <div class="hero-container">
                <!-- Left Side: Chat Interface -->
                <div class="chat-main-panel">
                    <div class="chat-header-main">
<<<<<<< HEAD
                        <div class="ai-avatar-large">
                            <img src="/templates/assets/images/logo1.png" alt="AI Assistant" style="width: 60px; height: 60px; border-radius: 50%; object-fit: contain;">
                        </div>
=======
                        <div class="ai-avatar-large">ü§ñ</div>
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                        <div class="ai-info-main">
                            <h2>Asistente Farmac√©utico</h2>
                            <p>Encuentra farmacias cerca de ti</p>
                        </div>
                    </div>
                    
                    <!-- Chat History Display -->
                    <div class="chat-messages-main" id="mainChatMessages">
                        <div class="message ai-message-main">
                            <div class="message-content-main">
                                <p>¬°Hola! Ingresa tu direcci√≥n o preg√∫ntame sobre farmacias cerca de ti.</p>
                                <span class="message-time-main">Ahora</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Chat Input -->
                    <div class="chat-input-main">
                        <input type="text" 
                               placeholder="Pregunta: ¬øHay farmacia de turno en Santiago?" 
                               id="mainChatInput"
                               class="chat-input-field-main"
                               autocomplete="off">
                        <button id="mainChatSend" class="chat-send-main">
                            Enviar
                        </button>
                    </div>
                </div>
                
                <!-- Right Side: Address & Map -->
                <div class="location-panel">
                    <div class="address-input-section">
                        <label for="addressInput">üìç Tu Ubicaci√≥n</label>
                        <div class="address-input-container">
                            <input type="text" 
                                   id="addressInput"
                                   placeholder="Ej: Providencia 123, Santiago"
                                   class="address-input-field"
                                   autocomplete="off">
                            <button id="useLocationBtn" class="use-location-btn">
                                üìç Usar mi ubicaci√≥n
                            </button>
                        </div>
                        <div id="addressSuggestions" class="address-suggestions"></div>
                    </div>
                    
                    <!-- Mini Map Preview -->
                    <div class="map-preview-container">
                        <div id="mapPreview" class="map-preview"></div>
                    </div>
                    
                    <!-- Quick Actions -->
                    <div class="quick-actions-main">
                        <button class="action-btn-main" data-action="open-now">üïê Abiertas ahora</button>
                        <button class="action-btn-main" data-action="medications">üíä Medicamentos</button>
                        <button class="action-btn-main" data-action="nearest">üöó M√°s cercana</button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Main Content -->
    <main class="main-content">
<<<<<<< HEAD
=======
        <!-- Statistics Section -->
        <section class="stats-section">
            <div class="stats-grid">
                <div class="stat-card fade-in stagger-1">
                    <div class="stat-number" id="total-pharmacies">0</div>
                    <div class="stat-label">Total Farmacias</div>
                </div>
                <div class="stat-card fade-in stagger-2">
                    <div class="stat-number" id="open-pharmacies">0</div>
                    <div class="stat-label">De Turno</div>
                </div>
                <div class="stat-card fade-in stagger-3">
                    <div class="stat-number" id="communes-count">0</div>
                    <div class="stat-label">Comunas</div>
                </div>
                <div class="stat-card fade-in stagger-4">
                    <div class="stat-time" id="current-time">--:--:--</div>
                    <div class="stat-label">Hora Actual</div>
                </div>
            </div>
        </section>

>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
        <!-- Search Controls -->
        <section class="search-controls">
            <div class="search-controls-grid">
                <input 
                    type="text" 
                    id="search-input" 
                    class="search-input"
                    placeholder="Buscar por comuna (ej: santiago, valpara√≠so)" 
                    list="communes-list" 
                    autocomplete="off"
                >
                <datalist id="communes-list">
                    <!-- Communes will be loaded dynamically -->
                </datalist>
                
                <select id="filter-select" class="filter-select">
                    <option value="all">Todas las farmacias</option>
                    <option value="open">Solo de turno</option>
                    <option value="open-now">Abiertas ahora</option>
                </select>
                
                <button id="search-btn" class="btn btn-primary">
                    üîç Buscar
                </button>
                
                <button id="location-btn" class="btn btn-success">
                    üìç Mi Ubicaci√≥n
                </button>
                
                <button id="clear-btn" class="btn btn-secondary">
                    üóëÔ∏è Limpiar
                </button>
            </div>
        </section>

        <!-- Map Section -->
        <section class="content-section">
            <div class="section-header">
                <h2 class="section-title">üó∫Ô∏è Mapa Interactivo</h2>
            </div>
            <div class="section-content">
                <div class="map-section">
                    <div id="map"></div>
                </div>
            </div>
        </section>

        <!-- Results Section -->
        <section class="content-section results-section">
            <div class="section-header">
                <div class="results-header">
                    <h2 class="results-title">üìã Farmacias Encontradas</h2>
                    <div class="results-count" id="results-count">
                        Realiza una b√∫squeda para ver resultados
                    </div>
                </div>
                <div class="filter-chips" id="filter-chips">
                    <span class="chip active" data-filter="all">Todas</span>
                    <span class="chip" data-filter="open">De Turno</span>
                    <span class="chip" data-filter="open-now">Abiertas Ahora</span>
                    <span class="chip" data-filter="nearby">Cercanas</span>
                </div>
            </div>
            <div class="section-content">
                <div id="results-container">
                    <!-- Results will be populated here -->
                    <div class="pharmacy-grid-empty">
                        <div class="empty-icon">üîç</div>
                        <div class="empty-title">Busca tu farmacia ideal</div>
                        <div class="empty-description">
                            Usa el buscador o nuestro asistente inteligente para encontrar farmacias cerca de ti.
                        </div>
                        <button class="btn btn-primary" onclick="document.getElementById('search-input').focus()">
                            Comenzar b√∫squeda
                        </button>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay" style="display: none;">
        <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando...</span>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <!-- Our JavaScript modules -->
    <script type="module">
        // Import our modules
        import { ThemeManager } from '/templates/assets/js/theme.js';
        import { PharmacyFinder } from '/templates/assets/js/main.js';
        
<<<<<<< HEAD
        // Debug function for theme toggle
        function debugThemeToggle() {
            const toggle = document.getElementById('themeToggle');
            if (toggle) {
                console.log('üîß Theme toggle found:', toggle);
                console.log('üîß Current theme attribute:', document.documentElement.getAttribute('data-theme'));
                
                // Add manual click handler for debugging
                toggle.addEventListener('click', function(e) {
                    console.log('üîß Manual click detected');
                    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    console.log('üîß Switching from', currentTheme, 'to', newTheme);
                    document.documentElement.setAttribute('data-theme', newTheme);
                    localStorage.setItem('theme', newTheme);
                });
            } else {
                console.log('‚ùå Theme toggle not found');
            }
        }
        
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
        // Initialize the application
        class App {
            constructor() {
                this.theme = new ThemeManager();
                this.pharmacyFinder = new PharmacyFinder();
                this.sessionId = null; // Initialize chat session ID
                this.mapPreview = null; // Map preview instance
<<<<<<< HEAD
                this.mainMap = null; // Main map instance
                this.currentLocationMarker = null; // Current location marker
                this.pharmacyMarkers = []; // Array to store pharmacy markers
                this.pharmacyMarkersGroup = null; // Layer group for pharmacy markers
                this.previewPharmacyMarkersGroup = null; // Layer group for pharmacy markers on preview map
                this.logoAnimationInterval = null; // For typing indicator logo animation
=======
                this.currentLocationMarker = null; // Current location marker
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                this.initIntegratedChat();
                
                // Make globally available for legacy code
                window.app = this.pharmacyFinder;
                window.themeManager = this.theme;
                
<<<<<<< HEAD
                // Debug theme toggle after a short delay
                setTimeout(debugThemeToggle, 1000);
                
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                console.log('üöÄ Integrated Pharmacy Finder App initialized');
            }
            
            initIntegratedChat() {
                const chatInput = document.getElementById('mainChatInput');
                const chatSend = document.getElementById('mainChatSend');
                const chatMessages = document.getElementById('mainChatMessages');
                const addressInput = document.getElementById('addressInput');
                const useLocationBtn = document.getElementById('useLocationBtn');
                
                console.log('üîß Initializing integrated chat...', {
                    chatInput: !!chatInput,
                    chatSend: !!chatSend,
                    chatMessages: !!chatMessages
                });
                
                // Initialize map preview
                this.initMapPreview();
                
<<<<<<< HEAD
                // Initialize main map
                this.initMainMap();
                
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                if (chatInput && chatSend) {
                    chatSend.addEventListener('click', () => {
                        console.log('üí¨ Send button clicked');
                        this.sendMessage();
                    });
                    chatInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            console.log('üí¨ Enter key pressed');
                            this.sendMessage();
                        }
                    });
                    console.log('‚úÖ Chat event listeners attached');
                } else {
                    console.error('‚ùå Chat elements not found!');
                }
                
                if (useLocationBtn) {
                    useLocationBtn.addEventListener('click', () => this.useCurrentLocation());
                }
                
                // Address input with autocomplete
                if (addressInput) {
                    addressInput.addEventListener('input', (e) => this.handleAddressInput(e.target.value));
                }
                
                // Quick action buttons
                document.querySelectorAll('.action-btn-main').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const action = e.target.dataset.action;
                        this.handleQuickAction(action);
                    });
                });
            }
            
            initMapPreview() {
                // Initialize map preview
                try {
                    if (window.L) {
                        this.mapPreview = L.map('mapPreview', {
                            zoomControl: false,
                            attributionControl: false,
                            dragging: false,
                            touchZoom: false,
                            doubleClickZoom: false,
                            scrollWheelZoom: false,
                            boxZoom: false,
                            keyboard: false
                        }).setView([-33.4489, -70.6693], 10);

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: ''
                        }).addTo(this.mapPreview);
                        
<<<<<<< HEAD
                        // Initialize pharmacy markers group for preview map
                        this.previewPharmacyMarkersGroup = L.layerGroup().addTo(this.mapPreview);
                        
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                        console.log('üó∫Ô∏è Map preview initialized');
                    } else {
                        console.warn('Leaflet not loaded, map preview not initialized');
                    }
                } catch (error) {
                    console.error('Error initializing map preview:', error);
                }
            }
            
<<<<<<< HEAD
            initMainMap() {
                // Initialize main interactive map
                try {
                    if (window.L && !this.mainMap) { // Check if map is not already initialized
                        this.mainMap = L.map('map').setView([-33.4489, -70.6693], 10);

                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '¬© OpenStreetMap contributors'
                        }).addTo(this.mainMap);
                        
                        // Initialize pharmacy markers group
                        this.pharmacyMarkersGroup = L.layerGroup().addTo(this.mainMap);
                        
                        console.log('üó∫Ô∏è Main map initialized');
                    } else if (this.mainMap) {
                        console.log('üó∫Ô∏è Main map already initialized, skipping');
                    } else {
                        console.warn('Leaflet not loaded, main map not initialized');
                    }
                } catch (error) {
                    console.error('Error initializing main map:', error);
                }
            }
            
            showPharmaciesOnMap(pharmacies, userLocation = null) {
                console.log('üè• HTML: Showing pharmacies on map:', pharmacies);
                
                // **DELEGATE TO PHARMACY FINDER INSTANCE**
                if (this.pharmacyFinder && this.pharmacyFinder.showPharmaciesOnMap) {
                    console.log('‚úÖ Using PharmacyFinder.showPharmaciesOnMap method');
                    this.pharmacyFinder.showPharmaciesOnMap(pharmacies, userLocation);
                } else {
                    console.warn('‚ùå PharmacyFinder not available, using fallback');
                    // Fallback to existing implementation if needed
                    this.showPharmaciesOnMapFallback(pharmacies, userLocation);
                }
            }
            
            showPharmaciesOnMapFallback(pharmacies, userLocation = null) {
                console.log('üè• Showing pharmacies on map:', pharmacies);
                
                if (!this.mainMap || !this.pharmacyMarkersGroup) {
                    console.warn('Map not initialized');
                    return;
                }
                
                // Clear existing pharmacy markers
                this.pharmacyMarkersGroup.clearLayers();
                
                if (!pharmacies || pharmacies.length === 0) {
                    console.log('No pharmacies to show');
                    return;
                }
                
                const bounds = [];
                
                // Add user location marker if provided
                if (userLocation && userLocation.latitud && userLocation.longitud) {
                    const userMarker = L.marker([userLocation.latitud, userLocation.longitud], {
                        icon: L.divIcon({
                            className: 'user-location-marker',
                            html: 'üìç',
                            iconSize: [30, 30],
                            iconAnchor: [15, 30]
                        })
                    }).bindPopup('Tu ubicaci√≥n');
                    
                    this.pharmacyMarkersGroup.addLayer(userMarker);
                    bounds.push([userLocation.latitud, userLocation.longitud]);
                }
                
                // Add pharmacy markers
                pharmacies.forEach((pharmacy, index) => {
                    if (pharmacy.ubicacion && pharmacy.ubicacion.latitud && pharmacy.ubicacion.longitud) {
                        const lat = pharmacy.ubicacion.latitud;
                        const lng = pharmacy.ubicacion.longitud;
                        
                        // Create custom icon for pharmacy
                        const isOpen = pharmacy.abierta || pharmacy.turno;
                        const iconHtml = isOpen ? 'üü¢' : 'üî¥';
                        
                        const marker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'pharmacy-marker',
                                html: `<div class="marker-content">${iconHtml}<span>${index + 1}</span></div>`,
                                iconSize: [30, 30],
                                iconAnchor: [15, 30]
                            })
                        });
                        
                        // Create popup content
                        const popupContent = `
                            <div class="pharmacy-popup">
                                <h3>${pharmacy.nombre}</h3>
                                <p><strong>üìç</strong> ${pharmacy.direccion}, ${pharmacy.comuna}</p>
                                <p><strong>üìû</strong> ${pharmacy.telefono}</p>
                                <p><strong>‚è∞</strong> ${pharmacy.horario}</p>
                                <p><strong>üåô</strong> ${pharmacy.turno ? 'Farmacia de turno' : 'Horario regular'}</p>
                                <p><strong>üü¢</strong> ${isOpen ? 'Abierta ahora' : 'Cerrada'}</p>
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        this.pharmacyMarkersGroup.addLayer(marker);
                        bounds.push([lat, lng]);
                    }
                });
                
                // Fit map to show all markers
                if (bounds.length > 0) {
                    this.mainMap.fitBounds(bounds, { padding: [20, 20] });
                }
                
                // Auto-scroll to map section
                document.getElementById('map').scrollIntoView({ behavior: 'smooth' });
            }
            
            showPharmaciesOnMapPreview(pharmacies, userLocation = null) {
                console.log('üè• Showing pharmacies on map preview:', pharmacies);
                
                if (!this.mapPreview || !this.previewPharmacyMarkersGroup) {
                    console.warn('Map preview not initialized');
                    return;
                }
                
                // Clear existing pharmacy markers from preview
                this.previewPharmacyMarkersGroup.clearLayers();
                
                if (!pharmacies || pharmacies.length === 0) {
                    console.log('No pharmacies to show on preview');
                    return;
                }
                
                const bounds = [];
                
                // Add user location marker if provided
                if (userLocation && userLocation.latitud && userLocation.longitud) {
                    const userMarker = L.marker([userLocation.latitud, userLocation.longitud], {
                        icon: L.divIcon({
                            className: 'user-location-marker',
                            html: 'üìç',
                            iconSize: [20, 20],
                            iconAnchor: [10, 20]
                        })
                    }).bindPopup('Tu ubicaci√≥n');
                    
                    this.previewPharmacyMarkersGroup.addLayer(userMarker);
                    bounds.push([userLocation.latitud, userLocation.longitud]);
                }
                
                // Add pharmacy markers to preview map
                pharmacies.forEach((pharmacy, index) => {
                    if (pharmacy.ubicacion && pharmacy.ubicacion.latitud && pharmacy.ubicacion.longitud) {
                        const lat = pharmacy.ubicacion.latitud;
                        const lng = pharmacy.ubicacion.longitud;
                        
                        // Create smaller icons for preview map
                        const isOpen = pharmacy.abierta || pharmacy.turno;
                        const iconHtml = isOpen ? 'üü¢' : 'üî¥';
                        
                        const marker = L.marker([lat, lng], {
                            icon: L.divIcon({
                                className: 'pharmacy-marker-preview',
                                html: `<div class="marker-content-preview">${iconHtml}</div>`,
                                iconSize: [16, 16],
                                iconAnchor: [8, 16]
                            })
                        });
                        
                        // Create simple popup for preview
                        const popupContent = `
                            <div class="pharmacy-popup-preview">
                                <strong>${pharmacy.nombre}</strong><br>
                                ${pharmacy.direccion}<br>
                                ${isOpen ? 'üü¢ Abierta' : 'üî¥ Cerrada'}
                            </div>
                        `;
                        
                        marker.bindPopup(popupContent);
                        this.previewPharmacyMarkersGroup.addLayer(marker);
                        bounds.push([lat, lng]);
                    }
                });
                
                // Fit preview map to show all markers
                if (bounds.length > 0) {
                    this.mapPreview.fitBounds(bounds, { padding: [10, 10] });
                }
                
                console.log('üó∫Ô∏è Map preview updated with', pharmacies.length, 'pharmacies');
            }
            
            checkAndShowPharmaciesOnMap(responseData) {
                console.log('üîç Checking response for pharmacy data:', responseData);
                console.log('üîç Response keys:', Object.keys(responseData));
                
                // Check if response contains tool results
                if (responseData.tool_results) {
                    console.log('‚úÖ Found tool_results:', responseData.tool_results.length, 'tools');
                    for (const toolResult of responseData.tool_results) {
                        console.log('üîß Checking tool result:', toolResult);
                        console.log('üîß Tool name:', toolResult.tool);
                        console.log('üîß Tool success:', toolResult.success);
                        
                        // Check for pharmacy search tools
                        if (toolResult.tool === 'search_farmacias_nearby' || toolResult.tool === 'search_farmacias') {
                            console.log('üè• Found pharmacy search tool!');
                            console.log('üè• Tool result data structure:', toolResult.data);
                            console.log('üè• Tool result data keys:', toolResult.data ? Object.keys(toolResult.data) : 'No data');
                            
                            // Check deeper structure - it seems data has nested data
                            if (toolResult.data && toolResult.data.data) {
                                console.log('üè• Nested data structure:', toolResult.data.data);
                                console.log('üè• Nested data keys:', Object.keys(toolResult.data.data));
                            }
                            
                            // Try both possible structures
                            let pharmacyData = null;
                            let userLocation = null;
                            
                            if (toolResult.success && toolResult.data) {
                                // Try nested structure first
                                if (toolResult.data.data && toolResult.data.data.farmacias) {
                                    pharmacyData = toolResult.data.data.farmacias;
                                    if (toolResult.data.data.resumen) {
                                        const resumen = toolResult.data.data.resumen;
                                        if (resumen.latitud && resumen.longitud) {
                                            userLocation = {
                                                latitud: resumen.latitud,
                                                longitud: resumen.longitud
                                            };
                                        }
                                    }
                                }
                                // Try direct structure as fallback
                                else if (toolResult.data.farmacias) {
                                    pharmacyData = toolResult.data.farmacias;
                                    if (toolResult.data.resumen) {
                                        const resumen = toolResult.data.resumen;
                                        if (resumen.latitud && resumen.longitud) {
                                            userLocation = {
                                                latitud: resumen.latitud,
                                                longitud: resumen.longitud
                                            };
                                        }
                                    }
                                }
                            }
                            
                            if (pharmacyData) {
                                console.log('üè• Found pharmacy data:', pharmacyData.length, 'pharmacies');
                                console.log('üè• First pharmacy:', pharmacyData[0]);
                                
                                console.log('üìç User location from resumen:', userLocation);
                                
                                // Show pharmacies on both main map and preview map
                                console.log('üó∫Ô∏è About to show pharmacies on maps...');
                                this.showPharmaciesOnMap(pharmacyData, userLocation);
                                this.showPharmaciesOnMapPreview(pharmacyData, userLocation);
                                
                                // **RESTORED: Display pharmacy cards**
                                console.log('üè• About to display pharmacy cards...');
                                this.displayPharmacyCards(pharmacyData, userLocation);
                                
                                return; // Exit after first match
                            } else {
                                console.log('‚ùå Tool succeeded but no pharmacy data found in any structure');
                                console.log('‚ùå Available data:', toolResult.data);
                            }
                        } else {
                            console.log('‚è≠Ô∏è Not a pharmacy search tool:', toolResult.tool);
                        }
                    }
                } else {
                    console.log('‚ùå No tool_results in response');
                }
                
                // Alternative: Check if response directly contains pharmacy data
                if (responseData.farmacias) {
                    console.log('üè• Found direct pharmacy data:', responseData.farmacias);
                    this.showPharmaciesOnMap(responseData.farmacias);
                    this.showPharmaciesOnMapPreview(responseData.farmacias);
                    this.displayPharmacyCards(responseData.farmacias);
                } else {
                    console.log('‚ùå No direct pharmacy data either');
                }
            }
            
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
            async sendMessage() {
                console.log('üì§ sendMessage called');
                const input = document.getElementById('mainChatInput');
                const message = input.value.trim();
                console.log('üí¨ Message to send:', message);
                
                if (!message) {
                    console.log('‚ùå Empty message, returning');
                    return;
                }
                
                this.addMessage('user', message);
                input.value = '';
                
<<<<<<< HEAD
                await this.sendToAgent(message);
            }
            
            async sendCoordinatesMessage(message) {
                console.log('üìç sendCoordinatesMessage called with:', message);
                await this.sendToAgent(message);
            }
            
            async sendToAgent(message) {
                // Add typing indicator
                this.showTypingIndicator();
                
                // Normal timing for production use
                const minDisplayTime = 2500; // 2.5 seconds - enough to see the animation
                const startTime = Date.now();
                
=======
                // Add typing indicator
                this.showTypingIndicator();
                
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                const payload = { 
                    message: message,
                    session_id: this.sessionId || null 
                };
                console.log('üì§ Sending payload:', payload);
                
                try {
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    console.log('üì• Response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('üì• Response data:', data);
                    
<<<<<<< HEAD
                    // Calculate how long to wait before hiding the typing indicator
                    const elapsedTime = Date.now() - startTime;
                    const remainingTime = Math.max(0, minDisplayTime - elapsedTime);
                    
                    // Wait for the remaining time to ensure minimum display duration
                    setTimeout(() => {
                        this.hideTypingIndicator();
                        
                        // Store session ID for future messages
                        if (data.session_id) {
                            this.sessionId = data.session_id;
                            console.log('üîê Session ID stored:', this.sessionId);
                        }
                        
                        // Display AI response
                        const aiMessage = data.reply || data.response || 'Respuesta recibida';
                        this.addMessage('ai', aiMessage);
                        
                        // Check if response contains pharmacy data and show on map
                        this.checkAndShowPharmaciesOnMap(data);
                        
                        // Show tools used if any
                        if (data.tools_used && data.tools_used.length > 0) {
                            console.log('üîß Tools used:', data.tools_used);
                            this.addMessage('ai', `üîß Herramientas utilizadas: ${data.tools_used.join(', ')}`);
                        }
                    }, remainingTime);
=======
                    this.hideTypingIndicator();
                    
                    // Store session ID for future messages
                    if (data.session_id) {
                        this.sessionId = data.session_id;
                        console.log('üîê Session ID stored:', this.sessionId);
                    }
                    
                    // Display AI response
                    const aiMessage = data.reply || data.response || 'Respuesta recibida';
                    this.addMessage('ai', aiMessage);
                    
                    // Show tools used if any
                    if (data.tools_used && data.tools_used.length > 0) {
                        console.log('üîß Tools used:', data.tools_used);
                        this.addMessage('ai', `üîß Herramientas utilizadas: ${data.tools_used.join(', ')}`);
                    }
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                    
                } catch (error) {
                    console.error('‚ùå Error sending message:', error);
                    this.hideTypingIndicator();
                    this.addMessage('ai', 'Lo siento, hubo un error conectando con el servidor. Por favor intenta de nuevo.');
                }
            }
            
            showTypingIndicator() {
                const messagesContainer = document.getElementById('mainChatMessages');
                const typingDiv = document.createElement('div');
                typingDiv.id = 'typingIndicator';
                typingDiv.className = 'message ai-message-main typing-indicator';
                typingDiv.innerHTML = `
                    <div class="message-content-main">
<<<<<<< HEAD
                        <div class="typing-avatar-container">
                            <img id="typingLogo" src="/templates/assets/images/logo_yellow.png" alt="Thinking..." style="width: 40px; height: 40px; border-radius: 50%; object-fit: contain; transition: all 0.2s ease;">
                        </div>
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                        <div class="typing-dots">
                            <span></span><span></span><span></span>
                        </div>
                        <span style="color: var(--text-muted); font-size: 0.8rem;">El asistente est√° escribiendo...</span>
                    </div>
                `;
                messagesContainer.appendChild(typingDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
<<<<<<< HEAD
                
                // Start the logo animation cycle after a short delay
                setTimeout(() => {
                    this.startLogoAnimation();
                }, 100);
            }
            
            hideTypingIndicator() {
                // Stop the animation first
                this.stopLogoAnimation();
                
=======
            }
            
            hideTypingIndicator() {
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                const indicator = document.getElementById('typingIndicator');
                if (indicator) {
                    indicator.remove();
                }
            }
            
<<<<<<< HEAD
            startLogoAnimation() {
                const logos = [
                    '/templates/assets/images/logo_yellow.png',
                    '/templates/assets/images/logo_green.png', 
                    '/templates/assets/images/logo_red.png'
                ];
                
                let currentIndex = -1; // Start at -1 so first increment makes it 0
                const logoImg = document.getElementById('typingLogo');
                
                if (!logoImg) {
                    console.log('‚ùå No typing logo element found');
                    return;
                }
                
                // Store the interval ID so we can clear it later
                this.logoAnimationInterval = setInterval(() => {
                    currentIndex = (currentIndex + 1) % logos.length;
                    logoImg.src = logos[currentIndex];
                }, 400); // Perfect speed: Fast enough to show activity, slow enough to see each color
            }
            
            stopLogoAnimation() {
                if (this.logoAnimationInterval) {
                    clearInterval(this.logoAnimationInterval);
                    this.logoAnimationInterval = null;
                }
            }
            
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
            handleAddressInput(value) {
                if (value.length < 3) {
                    this.hideAddressSuggestions();
                    return;
                }
                
                // Simple address suggestions (can be enhanced with real geocoding API)
                const suggestions = [
                    'Santiago, Regi√≥n Metropolitana',
                    'Providencia, Santiago',
                    'Las Condes, Santiago',
                    '√ëu√±oa, Santiago',
                    'Valpara√≠so, Regi√≥n de Valpara√≠so',
                    'Vi√±a del Mar, Regi√≥n de Valpara√≠so',
                    'Concepci√≥n, Regi√≥n del Biob√≠o'
                ].filter(suggestion => 
                    suggestion.toLowerCase().includes(value.toLowerCase())
                );
                
                this.showAddressSuggestions(suggestions);
            }
            
            showAddressSuggestions(suggestions) {
                const container = document.getElementById('addressSuggestions');
                if (!container) return;
                
                if (suggestions.length === 0) {
                    this.hideAddressSuggestions();
                    return;
                }
                
                container.innerHTML = suggestions.map(suggestion => 
                    `<div class="suggestion-item" onclick="app.selectAddress('${suggestion}')">${suggestion}</div>`
                ).join('');
                
                container.style.display = 'block';
            }
            
            hideAddressSuggestions() {
                const container = document.getElementById('addressSuggestions');
                if (container) {
                    container.style.display = 'none';
                }
            }
            
            selectAddress(address) {
                const input = document.getElementById('addressInput');
                if (input) {
                    input.value = address;
                    this.hideAddressSuggestions();
                    this.addMessage('ai', `üìç Ubicaci√≥n seleccionada: ${address}. Buscando farmacias cercanas...`);
                    // Here you would typically geocode the address and search for nearby pharmacies
                }
            }
            
<<<<<<< HEAD
            // Simple markdown to HTML converter (with clickable links)
            parseMarkdown(text) {
                if (!text) return '';
                let result = text;
                // Bold: **text** -> <strong>text</strong>
                result = result.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                // Markdown links: [text](url) -> <a href="url" target="_blank" class="pharmacy-link">text</a>
                result = result.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2" target="_blank" class="pharmacy-link">$1</a>');
                // Line breaks
                result = result.replace(/\n\n/g, '<br><br>');
                result = result.replace(/\n/g, '<br>');
                // Phone links: tel:+... -> clickable
                result = result.replace(/\b(tel:\+\d[\d\-\s]*)/g, '<a href="$1" class="phone-link">üìû Llamar</a>');
                return result;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text || '';
                return div.innerHTML;
            }
            
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
            addMessage(type, content) {
                const messagesContainer = document.getElementById('mainChatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}-message-main`;
                
                const time = new Date().toLocaleTimeString('es-CL', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
<<<<<<< HEAD
                // Format AI messages with clickable links and proper container
                let innerHtml;
                if (type === 'ai') {
                    const formattedContent = this.parseMarkdown(content);
                    innerHtml = `
                        <div class="message-content-main">
                            <div class="ai-response-content">${formattedContent}</div>
                            <span class="message-time-main">${time}</span>
                        </div>
                    `;
                } else {
                    innerHtml = `
                        <div class="message-content-main">
                            <p>${this.escapeHtml(content)}</p>
                            <span class="message-time-main">${time}</span>
                        </div>
                    `;
                }
                
                messageDiv.innerHTML = innerHtml;
=======
                messageDiv.innerHTML = `
                    <div class="message-content-main">
                        <p>${content}</p>
                        <span class="message-time-main">${time}</span>
                    </div>
                `;
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            useCurrentLocation() {
                console.log('üìç useCurrentLocation called');
                const useLocationBtn = document.getElementById('useLocationBtn');
                
                if (!navigator.geolocation) {
                    alert('Geolocalizaci√≥n no disponible en tu navegador');
                    return;
                }
                
                // Disable button and show loading state
                if (useLocationBtn) {
                    useLocationBtn.disabled = true;
                    useLocationBtn.textContent = 'üìç Obteniendo ubicaci√≥n...';
                }
                
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        const { latitude, longitude } = position.coords;
                        console.log('üìç Location obtained:', latitude, longitude);
                        
<<<<<<< HEAD
                        // **UPDATE MAIN HERO MAP WITH USER LOCATION**
                        if (window.app && window.app.updateMapWithUserLocation) {
                            console.log('üó∫Ô∏è Updating main hero map with user location');
                            window.app.updateMapWithUserLocation(latitude, longitude);
                        }
                        
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                        // Update the map preview with new location
                        if (this.mapPreview) {
                            this.mapPreview.setView([latitude, longitude], 14);
                            
                            // Remove existing marker if any
                            if (this.currentLocationMarker) {
                                this.mapPreview.removeLayer(this.currentLocationMarker);
                            }
                            
                            // Add new marker for current location
                            this.currentLocationMarker = L.marker([latitude, longitude])
                                .addTo(this.mapPreview)
                                .bindPopup('üìç Tu ubicaci√≥n actual')
                                .openPopup();
                        }
                        
                        // Update address input with reverse geocoding (simplified)
                        const addressInput = document.getElementById('addressInput');
                        if (addressInput) {
                            addressInput.value = `Lat: ${latitude.toFixed(4)}, Lng: ${longitude.toFixed(4)}`;
                        }
                        
                        // Add message to chat
                        this.addMessage('ai', `üìç Ubicaci√≥n detectada. Buscando farmacias cerca de ti...`);
                        
<<<<<<< HEAD
                        // Send the coordinates message directly to the AI agent
                        const coordinatesMessage = `Buscar farmacias cerca de mi ubicaci√≥n: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`;
                        this.addMessage('user', coordinatesMessage);
                        
                        // Send the message directly to the AI agent without using the input field
                        setTimeout(() => {
                            this.sendCoordinatesMessage(coordinatesMessage);
=======
                        // Instead of using pharmacyFinder.searchNearby, send a message to the AI agent
                        // This ensures the AI agent handles the search and provides a natural response
                        this.addMessage('user', `Buscar farmacias cerca de mi ubicaci√≥n: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`);
                        
                        // Trigger the AI agent to process this request
                        setTimeout(() => {
                            this.sendMessage();
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
                        }, 500);
                        
                        // Reset button
                        if (useLocationBtn) {
                            useLocationBtn.disabled = false;
                            useLocationBtn.textContent = 'üìç Usar mi ubicaci√≥n';
                        }
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        this.addMessage('ai', 'No pude obtener tu ubicaci√≥n. Puedes ingresarla manualmente.');
                        
                        // Reset button
                        if (useLocationBtn) {
                            useLocationBtn.disabled = false;
                            useLocationBtn.textContent = 'üìç Usar mi ubicaci√≥n';
                        }
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }
            
<<<<<<< HEAD
            // **RESTORED: Display pharmacy cards in the results section**
            displayPharmacyCards(pharmacies, userLocation = null) {
                console.log('üè• displayPharmacyCards called with:', pharmacies?.length, 'pharmacies');
                
                if (!pharmacies || pharmacies.length === 0) {
                    console.log('‚ùå No pharmacies to display');
                    return;
                }
                
                // Use the PharmacyFinder's displayPharmacyCards method if available
                if (window.app && window.app.displayPharmacyCards) {
                    console.log('‚úÖ Using PharmacyFinder.displayPharmacyCards method');
                    window.app.displayPharmacyCards(pharmacies, userLocation);
                    return;
                }
                
                // Fallback implementation
                console.log('‚ö†Ô∏è Using fallback displayPharmacyCards method');
                const pharmacyResults = document.getElementById('pharmacyResults');
                if (!pharmacyResults) {
                    console.log('‚ùå No pharmacy results container found');
                    return;
                }
                
                // Clear existing results
                pharmacyResults.innerHTML = '';
                
                // Create pharmacy cards HTML
                let cardsHTML = '<div class="pharmacy-grid">';
                
                pharmacies.forEach((pharmacy, index) => {
                    const isOpen = pharmacy.abierta || pharmacy.turno;
                    const statusClass = isOpen ? 'open' : 'closed';
                    
                    // Handle different address formats
                    let direccion = '';
                    if (typeof pharmacy.direccion === 'string') {
                        direccion = pharmacy.direccion;
                    } else if (pharmacy.direccion && pharmacy.direccion.calle) {
                        direccion = `${pharmacy.direccion.calle} ${pharmacy.direccion.numero || ''}`.trim();
                    } else {
                        direccion = 'Direcci√≥n no disponible';
                    }
                    
                    const comuna = pharmacy.comuna && typeof pharmacy.comuna === 'string' ? pharmacy.comuna : '';
                    
                    // Handle phone numbers
                    let telefono = '';
                    if (pharmacy.contacto && pharmacy.contacto.telefono) {
                        telefono = pharmacy.contacto.telefono;
                    } else if (pharmacy.telefono) {
                        telefono = pharmacy.telefono;
                    }
                    
                    // Handle schedule
                    let horario = '';
                    if (typeof pharmacy.horario === 'string') {
                        horario = pharmacy.horario;
                    } else if (pharmacy.horario && pharmacy.horario.display) {
                        horario = pharmacy.horario.display;
                    }
                    
                    // Calculate distance if user location is provided
                    let distance = '';
                    if (userLocation && pharmacy.latitud && pharmacy.longitud) {
                        const dist = this.calculateDistance(
                            userLocation.latitud, userLocation.longitud,
                            pharmacy.latitud, pharmacy.longitud
                        );
                        distance = `${dist.toFixed(1)} km`;
                    }
                    
                    cardsHTML += `
                        <div class="pharmacy-card" data-pharmacy-id="${index}">
                            <div class="pharmacy-card-header">
                                <div class="pharmacy-status ${statusClass}"></div>
                                ${distance ? `<div class="pharmacy-distance">${distance}</div>` : ''}
                            </div>
                            
                            <h3 class="pharmacy-name">${pharmacy.nombre || 'Farmacia'}</h3>
                            
                            <div class="pharmacy-details">
                                <div class="pharmacy-address">
                                    üìç ${direccion}${comuna ? `, ${comuna}` : ''}
                                </div>
                                
                                ${telefono ? `
                                    <div class="pharmacy-phone">
                                        üìû <a href="tel:${telefono}">${telefono}</a>
                                    </div>
                                ` : ''}
                                
                                ${horario ? `
                                    <div class="pharmacy-hours">
                                        üïê ${horario}
                                    </div>
                                ` : ''}
                                
                                ${pharmacy.turno ? `
                                    <div class="pharmacy-duty">
                                        üåô Farmacia de turno
                                    </div>
                                ` : ''}
                                
                                ${pharmacy.cadena && pharmacy.cadena !== 'Independiente' ? `
                                    <div class="pharmacy-chain">
                                        üè¢ ${pharmacy.cadena}
                                    </div>
                                ` : ''}
                            </div>
                            
                            <div class="pharmacy-actions">
                                <button class="btn btn-primary btn-sm" onclick="app.focusPharmacyOnMap?.(${index})">
                                    üó∫Ô∏è Ver en mapa
                                </button>
                                ${telefono ? `
                                    <button class="btn btn-success btn-sm" onclick="window.open('tel:${telefono}')">
                                        üìû Llamar
                                    </button>
                                ` : ''}
                                <button class="btn btn-info btn-sm" onclick="app.askAboutPharmacy?.(${index})">
                                    ‚ùì Pregunta por esta farmacia
                                </button>
                            </div>
                        </div>
                    `;
                });
                
                cardsHTML += '</div>';
                pharmacyResults.innerHTML = cardsHTML;
                
                // Show the results section
                const resultsSection = document.getElementById('results');
                if (resultsSection) {
                    resultsSection.style.display = 'block';
                }
                
                console.log(`‚úÖ Displayed ${pharmacies.length} pharmacy cards`);
            }
            
            // Helper function to calculate distance between two coordinates
            calculateDistance(lat1, lon1, lat2, lon2) {
                const R = 6371; // Earth's radius in kilometers
                const dLat = (lat2 - lat1) * Math.PI / 180;
                const dLon = (lon2 - lon1) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                        Math.sin(dLon/2) * Math.sin(dLon/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            }
            
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
            handleQuickAction(action) {
                switch(action) {
                    case 'open-now':
                        this.addMessage('user', 'Buscar farmacias abiertas ahora');
                        this.sendMessage();
                        break;
                    case 'medications':
                        this.addMessage('user', 'Informaci√≥n sobre medicamentos');
                        this.sendMessage();
                        break;
                    case 'nearest':
                        this.useCurrentLocation();
                        break;
                }
            }
<<<<<<< HEAD
            
            // **DELEGATION METHODS FOR PHARMACY FINDER**
            focusPharmacyOnMap(pharmacyIndex) {
                if (this.pharmacyFinder && this.pharmacyFinder.focusPharmacyOnMap) {
                    console.log('üîç Delegating focusPharmacyOnMap to PharmacyFinder');
                    this.pharmacyFinder.focusPharmacyOnMap(pharmacyIndex);
                } else {
                    console.error('‚ùå PharmacyFinder.focusPharmacyOnMap not available');
                }
            }
            
            askAboutPharmacy(pharmacyIndex) {
                if (this.pharmacyFinder && this.pharmacyFinder.askAboutPharmacy) {
                    console.log('üí¨ Delegating askAboutPharmacy to PharmacyFinder');
                    this.pharmacyFinder.askAboutPharmacy(pharmacyIndex);
                } else {
                    console.error('‚ùå PharmacyFinder.askAboutPharmacy not available');
                }
            }
            
            updateMapWithUserLocation(latitude, longitude) {
                if (this.pharmacyFinder && this.pharmacyFinder.updateMapWithUserLocation) {
                    console.log('üìç Delegating updateMapWithUserLocation to PharmacyFinder');
                    this.pharmacyFinder.updateMapWithUserLocation(latitude, longitude);
                } else {
                    console.error('‚ùå PharmacyFinder.updateMapWithUserLocation not available');
                }
            }
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
        }
        
        // Start the app when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
<<<<<<< HEAD
            // Ensure page starts at the top
            window.scrollTo(0, 0);
            document.documentElement.scrollTop = 0;
            document.body.scrollTop = 0;
            
=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
            window.app = new App();
        });
    </script>
    
<<<<<<< HEAD
    <!-- Service Worker Registration - Disabled for now -->
    <!--
=======
    <!-- Service Worker Registration -->
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
    <script>
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('SW registered: ', registration);
                    })
                    .catch(registrationError => {
                        console.log('SW registration failed: ', registrationError);
                    });
            });
        }
    </script>
<<<<<<< HEAD
    -->

    <!-- Footer with Status Link -->
    <footer style="
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 8px 16px;
        font-size: 12px;
        text-align: center;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 1000;
        border-top: 1px solid rgba(255,255,255,0.1);
    ">
        <div style="display: flex; justify-content: center; align-items: center; gap: 16px;">
            <span>üè• Farmacias Chile AI Assistant</span>
            <span style="color: rgba(255,255,255,0.7);">|</span>
            <a href="/status" style="
                color: white;
                text-decoration: none;
                padding: 4px 8px;
                border-radius: 4px;
                background: rgba(255,255,255,0.1);
                transition: all 0.3s ease;
                font-weight: 500;
            " 
            onmouseover="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(-1px)'" 
            onmouseout="this.style.background='rgba(255,255,255,0.1)'; this.style.transform='translateY(0)'">
                üìä System Status
            </a>
            <span style="color: rgba(255,255,255,0.7);">|</span>
            <span style="color: rgba(255,255,255,0.8); font-size: 11px;">v2.0</span>
        </div>
    </footer>

    <!-- Add some bottom padding to main content to avoid footer overlap -->
    <style>
        body {
            padding-bottom: 50px;
        }
        
        .chat-container {
            margin-bottom: 60px;
        }
        
        @media (max-width: 768px) {
            body {
                padding-bottom: 60px;
            }
            
            .chat-container {
                margin-bottom: 70px;
            }
        }
    </style>

=======
>>>>>>> da633d1c57d5615d9572b573a3630a8e062438a9
</body>
</html>
